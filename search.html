<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚­ãƒ£ã‚¹ãƒˆæ¤œç´¢</title>
  <link rel="stylesheet" href="css/search.css">
  <link rel="stylesheet" href="css/searchmodal.css">
  <link rel="stylesheet" href="css/tag.css">
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="chat-header">
    <button class="btn-back" onclick="history.back()">
      <img src="icon/back-b.png" alt="æˆ»ã‚‹">
    </button>
    <h2 class="header">ã‚­ãƒ£ã‚¹ãƒˆæ¤œç´¢</h2>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ é¢¨ãƒœã‚¿ãƒ³ -->
  <form id="buttonForm" class="search-trigger-form" tabindex="0" role="button" aria-label="">
    <input type="text" placeholder="å¥½ã¿ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚„ç³»çµ±æ¤œç´¢ãŒå¯èƒ½ã§ã™" disabled />
    <button type="button" disabled></button>
  </form>

  <!-- ğŸ”» ä¸‹ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="searchModal" class="bottom-modal">
    <div class="bottom-modal-content">
      <span id="closeSearchModal" class="close">&times;</span>
      <h2>æ¤œç´¢æ¡ä»¶</h2>
      
      <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
      <form id="searchForm">
        <fieldset>
          <legend>ã‚¹ã‚¿ã‚¤ãƒ«</legend>
          <label><input type="radio" name="style" value="ã‚¹ãƒ¬ãƒ³ãƒ€ãƒ¼">ã‚¹ãƒ¬ãƒ³ãƒ€ãƒ¼</label>
          <label><input type="radio" name="style" value="ã‚°ãƒ©ãƒãƒ¼">ã‚°ãƒ©ãƒãƒ¼</label>
        </fieldset>

        <fieldset>
          <legend>é¡”ç«‹ã¡</legend>
          <label><input type="radio" name="face" value="å¯æ„›ã„ç³»">å¯æ„›ã„ç³»</label>
          <label><input type="radio" name="face" value="ç¶ºéº—ç³»">ç¶ºéº—ç³»</label>
        </fieldset>

        <fieldset>
          <legend>ç³»çµ±</legend>
          <label><input type="radio" name="type" value="ã‚®ãƒ£ãƒ«">ã‚®ãƒ£ãƒ«</label>
          <label><input type="radio" name="type" value="æ¸…æ¥š">æ¸…æ¥š</label>
          <label><input type="radio" name="type" value="ã‚»ã‚¯ã‚·ãƒ¼">ã‚»ã‚¯ã‚·ãƒ¼</label>
          <label><input type="radio" name="type" value="ç«¥é¡”">ç«¥é¡”</label>
          <label><input type="radio" name="type" value="ãƒãƒ¼ãƒ•">ãƒãƒ¼ãƒ•</label>
        </fieldset>

        <label>å±…ä½åœ°:
          <select name="location" required>
            <option value="">æŒ‡å®šãªã—</option>
            <option value="åºƒå·">åºƒå·</option>
            <option value="æ·±åœ³">æ·±åœ³</option>
          </select>
        </label><br />

        <label>æ—¥æœ¬èª:
          <select name="japanese">
            <option value="">æŒ‡å®šãªã—</option>
            <option value="ãƒ“ã‚¸ãƒã‚¹ãƒ¬ãƒ™ãƒ«">ãƒ“ã‚¸ãƒã‚¹ãƒ¬ãƒ™ãƒ«</option>
            <option value="æ—¥å¸¸ä¼šè©±">æ—¥å¸¸ä¼šè©±</option>
            <option value="å°‘ã—ã ã‘">å°‘ã—ã ã‘</option>
            <option value="å–‹ã‚Œãªã„">å–‹ã‚Œãªã„</option>
          </select>
        </label><br />
      </form>
    </div>
  </div>


  <!-- æ¤œç´¢çµæœè¡¨ç¤º -->
  <div id="castList">
    <p class="loading">æ¤œç´¢æ¡ä»¶ã‚’é¸ã‚“ã§ãã ã•ã„</p>
  </div>

  <!-- Firebase & ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAAgvnIuIyEwF9u-SWfwe7rRw84bbzy2W0",
      authDomain: "matching-40a19.firebaseapp.com",
      projectId: "matching-40a19",
      storageBucket: "matching-40a19.firebasestorage.app",
      messagingSenderId: "162438647858",
      appId: "1:162438647858:web:9379c21ae921ccd8d0ac2b",
      measurementId: "G-DXEEFM6JNV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    document.querySelector('.btn-back').addEventListener('click', () => {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ â†’ å®‰å…¨ãªãƒšãƒ¼ã‚¸ã¸
          window.location.href = 'index.html';  // é©å®œå¤‰æ›´
        } else {
          // æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
          window.location.href = 'login.html';  // é©å®œå¤‰æ›´
        }
      });
    });

    //ã€€ãƒ¢ãƒ¼ãƒ€ãƒ«
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("searchModal");
      const formTrigger = document.getElementById("buttonForm");
      const closeBtn = document.getElementById("closeSearchModal");

      if (!modal || !formTrigger || !closeBtn) {
        console.error("ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®è¦ç´ ãŒå–å¾—ã§ãã¾ã›ã‚“", {
          modal,
          formTrigger,
          closeBtn,
        });
        return;
      }

      formTrigger.addEventListener("click", () => {
        modal.classList.add("show");
      });

      closeBtn.addEventListener("click", () => {
        modal.classList.remove("show");
      });

      window.addEventListener("click", (event) => {
        if (event.target === modal) {
          modal.classList.remove("show");
        }
      });
    });

    // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®å¤‰æ›´ã‚’ç›£è¦–
    const form = document.getElementById("searchForm");
    const castList = document.getElementById("castList");

    form.addEventListener('change', async () => {
      // å…¥åŠ›å€¤ã®å–å¾—
      const style = form.style.value;
      const face = form.face.value;
      const type = form.type.value;
      const location = form.location.value;
      const japanese = form.japanese.value;

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å€¤å–å¾—ï¼ˆè¤‡æ•°å¯ï¼‰
      const getCheckedValues = (name) =>
        [...form.querySelectorAll(`input[name="${name}"]:checked`)].map(el => el.value);

      const situations = getCheckedValues("situation");

      let q = collection(db, "casts");
      let filters = [];

      // ãã®ä»–ã®å˜ä¸€ãƒ•ã‚£ãƒ«ã‚¿
      if (style) filters.push(where("style", "==", style));
      if (face) filters.push(where("face", "==", face));
      if (type) filters.push(where("type", "==", type));
      if (location) filters.push(where("location", "==", location));
      if (japanese) filters.push(where("japanese", "==", japanese));

      // ã‚¯ã‚¨ãƒªç”Ÿæˆ
      const searchQuery = query(q, ...filters);

      try {
        const snapshot = await getDocs(searchQuery);

        // è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚¯ãƒªã‚¢
        castList.innerHTML = "";

        snapshot.forEach(doc => {
          const castData = doc.data();
          const id = doc.id;
          console.log(castData);
          const imageUrl = castData.images && castData.images[0] ? castData.images[0] : '';
          // ã‚¿ã‚°æ•´å½¢
          const formatTags = tags =>
            Array.isArray(tags) ? tags.map(t => `<span class="tag">${t}</span>`).join('') : tags ? `<span class="tag">${tags}</span>` : '';

          // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼‰
          const cardLink = document.createElement("a");
          cardLink.href = `castDetail.html?id=${id}`;
          cardLink.className = "cast-card-link"; // å¿…è¦ã«å¿œã˜ã¦è£…é£¾ç”¨ã‚¯ãƒ©ã‚¹
          cardLink.style.textDecoration = "none"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸‹ç·šã‚’å‰Šé™¤

          const card = document.createElement("div");
          card.className = "cast-card";
          card.innerHTML = `
            <div class="cast-card-horizontal">
              <img src="${imageUrl}" alt="icon" class="cast-photo" />
              <div class="cast-info">
                <h3 class="cast-name">${castData.nickname || "åå‰æœªè¨­å®š"}</h3>
                <div class="cast-meta">
                  <span class="cast-age">å¹´é½¢: ${castData.age || "æœªè¨­å®š"}</span>
                  <span class="cast-location">å±…ä½åœ°: ${castData.location || "æœªè¨­å®š"}</span>
                </div>
                <div class="tag-container">
                  ${formatTags(castData.style)}${formatTags(castData.face)}${formatTags(castData.type)}
                  ${formatTags(castData.job)}${formatTags(castData.situation)}${formatTags(castData.skill)}
                </div>
              </div>
            </div>
          `;

          // ã‚«ãƒ¼ãƒ‰ã‚’ãƒªãƒ³ã‚¯ã§å›²ã‚€
          cardLink.appendChild(card);
          castList.appendChild(cardLink);
        });

      } catch (error) {
        console.error("æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
      }
    });

  </script>

</body>
</html>
