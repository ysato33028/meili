<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </title>
  <link rel="stylesheet" href="css/chatRoom.css" />
</head>
<body>
  <div class="chat-header">
    <button class="btn-back">
      <img src="icon/back-b.png" alt="æˆ»ã‚‹">
    </button>
    <h2 class="header" id="chatPartnerName">ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h2>
  </div>

  <div id="chatContainer" class="chat-container"></div>

  <div class="chat-input-container">
    <textarea id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" class="chat-input" rows="1"></textarea>
    <button id="sendButton" class="send-button">
      <img src="icon/send.png" alt="é€ä¿¡" class="send-icon">
    </button>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, doc, query, orderBy, addDoc, serverTimestamp, onSnapshot , getDocs , updateDoc , getDoc , where , increment } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAAgvnIuIyEwF9u-SWfwe7rRw84bbzy2W0",
      authDomain: "matching-40a19.firebaseapp.com",
      projectId: "matching-40a19",
      storageBucket: "matching-40a19.firebasestorage.app",
      messagingSenderId: "162438647858",
      appId: "1:162438647858:web:9379c21ae921ccd8d0ac2b",
      measurementId: "G-DXEEFM6JNV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    //ã€€æˆ»ã‚‹
    document.querySelector('.btn-back').addEventListener('click', () => {
      window.history.back();
    });

    //ã€€æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é·ç§»
    function scrollToBottom() {
      const messages = chatContainer.querySelectorAll(".message-wrapper");
      if (messages.length) {
        messages[messages.length - 1].scrollIntoView({ behavior: "smooth", block: "end" });
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒ ã®è‡ªå‹•æŠ˜ã‚Šè¿”ã—
    const textarea = document.getElementById('messageInput');
    textarea.addEventListener('input', () => {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    });

    const chatContainer = document.getElementById('chatContainer');
    const urlParams = new URLSearchParams(window.location.search);
    const interactionId = urlParams.get("id");

    // é‡è¤‡é˜²æ­¢ã®ãŸã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚’ä¿å­˜
    const messageIds = new Set();
    const giftIds = new Set();

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©
    let interactionRef = null;
    let currentUserId = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user || !interactionId) return;

      currentUserId = user.uid;
      interactionRef = doc(db, "interactions", interactionId);

      // ç›¸æ‰‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã®å–å¾—
      const interactionSnap = await getDoc(interactionRef);
      if (!interactionSnap.exists()) {
        console.error("interactions ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ID:", interactionId);
        return;
      }
      // ğŸ”½ æœªèª­æ•°ã‚’ 0 ã«ãƒªã‚»ãƒƒãƒˆ
      try {
        await updateDoc(interactionRef, {
          [`unreadCounts.${currentUserId}`]: 0
        });
      } catch (error) {
        console.error("æœªèª­æ•°ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:", error);
      }

      const interactionData = interactionSnap.data();
      const participants = interactionData.participants;
      if (!Array.isArray(participants) || participants.length !== 2) {
        console.error("participants ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™", participants);
        return;
      }

      // è‡ªåˆ†ä»¥å¤–ã®IDã‚’å–å¾—
      const partnerId = participants.find(uid => uid !== currentUserId);

      // âœ… æ±ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—é–¢æ•°
      async function fetchUserProfile(uid) {
        const collections = ["casts", "male_users"];
        for (const col of collections) {
          const ref = col === "casts"
            ? query(collection(db, col), where("userUid", "==", uid))
            : query(collection(db, col), where("__name__", "==", uid));

          const snap = await getDocs(ref);
          if (!snap.empty) {
            const docData = snap.docs[0].data();
            return {
              nickname: docData.nickname || "ä¸æ˜",
              photoURL: (docData.images && Object.values(docData.images)[0]) || "icon/default.png"
            };
          }
        }
        console.warn("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", uid);
        return {
          nickname: "ä¸æ˜",
          photoURL: "icon/default.png"
        };
      }

      const partnerProfile = await fetchUserProfile(partnerId);

      // âœ… åå‰ã®è¡¨ç¤º
      document.getElementById("chatPartnerName").textContent = partnerProfile.nickname;

      // âœ… ç”»åƒã®è¡¨ç¤ºï¼ˆè¡¨ç¤ºå…ˆãŒ img è¦ç´ ãªã‚‰ã“ã¡ã‚‰ï¼‰
      const partnerImageEl = document.getElementById("chatPartnerImage");
      if (partnerImageEl) {
        partnerImageEl.src = partnerProfile.photoURL;
      }

      // 1. åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆçœç•¥ã—ã¦ã‚‚OKï¼‰
      const messagesSnapshot = await getDocs(query(collection(interactionRef, "messages")));
      const giftsSnapshot = await getDocs(query(collection(interactionRef, "gifts")));

      const allItems = [];

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…±é€šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ push
      messagesSnapshot.forEach(doc => {
        const data = doc.data();
        allItems.push({
          type: 'message',
          createdAt: data.createdAt?.toDate(),
          data: data,
          senderId: data.senderId
        });
        messageIds.add(doc.id); // åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«IDè¿½åŠ 
      });

      // ã‚®ãƒ•ãƒˆã‚‚å…±é€šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ push
      giftsSnapshot.forEach(doc => {
        const data = doc.data();
        allItems.push({
          type: 'gift',
          createdAt: data.createdAt?.toDate(),
          data: data,
          senderId: data.senderId
        });
        giftIds.add(doc.id); // åˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«IDè¿½åŠ 
      });

      // ä½œæˆæ—¥æ™‚ã§æ˜‡é †ã«ã‚½ãƒ¼ãƒˆ
      allItems.sort((a, b) => a.createdAt - b.createdAt);

      // ç”»é¢ã«æç”»
      allItems.forEach(item => {
        const type = item.senderId === currentUserId ? 'sent' : 'received';
        if (item.type === 'message') {
          displayMessage(item.data, type);
        } else if (item.type === 'gift') {
          displayGift(item.data, type);
        }
      });

      // 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ï¼ˆã“ã®ä¸­ã«ç§»å‹•ï¼‰
      onSnapshot(
        query(collection(interactionRef, "messages"), orderBy("createdAt", "asc")),
        (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            const docId = change.doc.id;
            const data = change.doc.data();

            if (change.type === "added" && !messageIds.has(docId)) {
              messageIds.add(docId);
              const type = data.senderId === currentUserId ? 'sent' : 'received';
              displayMessage(data, type, docId);
              scrollToBottom();
            }

            // ğŸ” createdAtã®è£œå®Œã‚’æ¤œçŸ¥ã—ã€timestamp ã‚’æ›´æ–°
            if (change.type === "modified") {
              const el = document.querySelector(`[data-id="${docId}"] .timestamp`);
              if (el && data.createdAt?.toDate) {
                el.textContent = formatTime(data.createdAt);
              }
            }
          });
        }
      );

      onSnapshot(
      query(collection(interactionRef, "gifts"), orderBy("createdAt", "asc")),
      async (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
          const data = change.doc.data();
          const giftId = change.doc.id;

          if (change.type === "added" && !giftIds.has(giftId)) {
            giftIds.add(giftId);
            const type = data.senderId === currentUserId ? 'sent' : 'received';
            displayGift(data, type);

            // æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ï¼ˆè‡ªåˆ†ãŒé€ä¿¡è€…ã§ãªã‘ã‚Œã°å¢—ã‚„ã™ï¼‰
            if (type === 'received') {
              try {
                await updateDoc(interactionRef, {
                  [`unreadCounts.${currentUserId}`]: increment(1)
                });
              } catch (error) {
                console.error("æœªèª­ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼ï¼ˆã‚®ãƒ•ãƒˆï¼‰:", error);
              }
            }
          }
        });
      }
    );
  });

  // é€ä¿¡å‡¦ç†ï¼ˆä¿®æ­£ä¸è¦ã ãŒ currentUserId ã‚’ä½¿ç”¨ï¼‰
  document.getElementById("sendButton").addEventListener("click", async () => {
    const messageText = textarea.value.trim();
    if (!messageText) return;

    const user = auth.currentUser;
    if (!user || !interactionRef) return;

    const message = {
      text: messageText,
      senderId: user.uid,
      createdAt: serverTimestamp(),
    };

    try {
      // ğŸ” interactions ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã—ã¦ partnerId ã‚’ç‰¹å®š
      const interactionSnap = await getDoc(interactionRef);
      const interactionData = interactionSnap.data();
      const participants = interactionData.participants || [];
      const partnerId = participants.find(uid => uid !== user.uid); // è‡ªåˆ†ã˜ã‚ƒãªã„æ–¹

      await addDoc(collection(interactionRef, "messages"), message);
      // interactions ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
      await updateDoc(interactionRef, {
        lastMessage: messageText,
        updatedAt: serverTimestamp(),
        [`unreadCounts.${partnerId}`]: increment(1)
      });
      textarea.value = "";
      textarea.style.height = "auto";
    } catch (error) {
      console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
    }
  });
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  function displayMessage(data, type, docId = null) {
    const wrapper = document.createElement("div");
    wrapper.className = `message-wrapper ${type}`;
    if (docId) wrapper.setAttribute("data-id", docId); // â† ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚’å±æ€§ã«ã‚»ãƒƒãƒˆ

    const bubble = document.createElement("div");
    bubble.className = `chat-bubble ${type}`;
    bubble.innerHTML = `<p>${sanitize(data.text)}</p>`;

    const time = document.createElement("span");
    time.className = "timestamp";
    time.textContent = formatTime(data.createdAt);

    wrapper.appendChild(bubble);
    wrapper.appendChild(time);
    chatContainer.appendChild(wrapper);
    // æœ«å°¾ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    scrollToBottom();
  }

  // ã‚®ãƒ•ãƒˆè¡¨ç¤º
  function displayGift(data, type) {
    const wrapper = document.createElement("div");
    wrapper.className = `message-wrapper ${type}`;

    const bubble = document.createElement("div");
    bubble.className = `chat-bubble gift ${type}`;
    bubble.innerHTML = `
      <p>ğŸ <strong>${sanitize(data.gift?.name || "ã‚®ãƒ•ãƒˆ")}</strong>ï¼ˆ${sanitize(data.gift?.price || "")}ï¼‰<br>
      ${sanitize(data.message)}</p>
    `;

    const time = document.createElement("span");
    time.className = "timestamp";
    time.textContent = formatTime(data.createdAt);

    wrapper.appendChild(bubble);
    wrapper.appendChild(time);
    chatContainer.appendChild(wrapper); // åŒã˜ãä¸‹ã«è¿½åŠ ã§OK
  }

  // æ™‚åˆ»è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  function formatTime(timestamp) {
    if (!timestamp?.toDate) return "";
    return timestamp.toDate().toLocaleString("ja-JP", {
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  // ã‚µãƒ‹ã‚¿ã‚¤ã‚º
  function sanitize(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }

  </script>

</body>
</html>
