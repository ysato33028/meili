<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒãƒ£ãƒƒãƒˆä¸€è¦§</title>
  <link rel="stylesheet" href="css/chatList.css" />
</head>
<body>
  <!-- æˆ»ã‚‹ + ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã§æ¨ªä¸¦ã³ã« -->
  <div class="chat-header">
    <button class="btn-back">
      <img src="icon/back-b.png" alt="æˆ»ã‚‹">
    </button>
    <h2 class="header">ãƒãƒ£ãƒƒãƒˆä¸€è¦§</h2>
  </div>
  <div id="chatList" class="chat-list"></div>

  <!-- Firebase SDK çµ±åˆ & ãƒãƒ£ãƒƒãƒˆä¸€è¦§è¡¨ç¤º -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAAgvnIuIyEwF9u-SWfwe7rRw84bbzy2W0",
    authDomain: "matching-40a19.firebaseapp.com",
    projectId: "matching-40a19",
    storageBucket: "matching-40a19.firebasestorage.app",
    messagingSenderId: "162438647858",
    appId: "1:162438647858:web:9379c21ae921ccd8d0ac2b",
    measurementId: "G-DXEEFM6JNV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const chatListContainer = document.getElementById("chatList");

  /**
   * uid ã«ä¸€è‡´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ casts â†’ male_users ã®é †ã§å–å¾—
   */
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ï¼šfemale_users â†’ castsï¼ˆuserUidï¼‰â†’ male_users ã®é †ã«æ¢ç´¢
  async function fetchUserProfile(uid) {
    console.log("ğŸ” fetchUserProfile å‘¼ã³å‡ºã—:", uid);

    // casts ã®ä¸­ã§ userUid ãŒä¸€è‡´ã™ã‚‹ã‹
    const castsRef = collection(db, "casts");
    const castQuery = query(castsRef, where("userUid", "==", uid));
    const castSnap = await getDocs(castQuery);
    if (!castSnap.empty) {
      const castDoc = castSnap.docs[0].data();
      console.log("âœ… casts ã‹ã‚‰å–å¾—:", castDoc);
      return {
        nickname: castDoc.nickname || "ä¸æ˜",
        photoURL: (castDoc.images && Object.values(castDoc.images)[0]) || "icon/default.png"
      };
    }

    // male_users ã‚’ uid ã§æ¢ã™
    const maleRef = doc(db, "male_users", uid);
    const maleSnap = await getDoc(maleRef);
    if (maleSnap.exists()) {
      const data = maleSnap.data();
      console.log("âœ… male_users ã‹ã‚‰å–å¾—:", data);
      return {
        nickname: data.nickname || "ä¸æ˜",
        photoURL: (data.images && Object.values(data.images)[0]) || "icon/default.png"
      };
    }

    console.warn("âš ï¸ ã©ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚‚è©²å½“ãªã—:", uid);
    return {
      nickname: "ä¸æ˜",
      photoURL: "icon/default.png"
    };
  }


  // ãƒãƒ£ãƒƒãƒˆä¸€è¦§ã‚’æç”»
  async function renderChatList(interactions, currentUserId) {
    chatListContainer.innerHTML = ""; // ã‚¯ãƒªã‚¢

    for (const docSnap of interactions) {
      const data = docSnap.data();
      if (!data.participants.includes(currentUserId)) continue;

      const otherUserId = data.participants.find(id => id !== currentUserId);
      const userData = await fetchUserProfile(otherUserId);

      const listItem = document.createElement("div");
      listItem.className = "chat-item";
      listItem.addEventListener("click", () => {
        window.location.href = `chatRoom.html?id=${docSnap.id}`;
      });

      // æ™‚åˆ»æ•´å½¢
      const formatTimestamp = (date) => {
        const now = new Date();
        const diffTime = now - date;
        const diffDays = diffTime / (1000 * 60 * 60 * 24);
        const isToday = date.toDateString() === now.toDateString();
        const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];

        if (isToday) {
          return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        } else if (diffDays < 7) {
          return weekdays[date.getDay()];
        } else if (diffDays < 365) {
          return `${date.getMonth() + 1}/${date.getDate()}`;
        } else {
          return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
        }
      };

      const lastMessage = data.lastMessage || (data.lastGift ? 'ã‚®ãƒ•ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸ' : '');
      const lastTime = data.updatedAt?.toDate ? formatTimestamp(data.updatedAt.toDate()) : '';

      listItem.innerHTML = `
        <img src="${userData.photoURL}" alt="icon" />
        <div class="chat-info">
          <div class="name">${userData.nickname}</div>
          <div class="message">${lastMessage}</div>
        </div>
        <div class="chat-time">${lastTime}</div>
      `;

      const unreadCountsForUser = data.unreadCounts?.[currentUserId] || 0;

      let unreadCount = 0;
      if (typeof unreadCountsForUser === 'object' && unreadCountsForUser !== null) {
        // messagesã¨giftsã®åˆè¨ˆ
        unreadCount = (unreadCountsForUser.messages || 0) + (unreadCountsForUser.gifts || 0);
      } else if (typeof unreadCountsForUser === 'number') {
        // messages + gifts ãŒçµ±åˆã•ã‚Œã¦1ã¤ã®æ•°å€¤ã¨ã—ã¦å…¥ã£ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹
        unreadCount = unreadCountsForUser;
      }

      if (unreadCount > 0) {
        const badge = document.createElement("span");
        badge.className = "unread-badge";
        badge.textContent = unreadCount;
        listItem.appendChild(badge);
      }

      chatListContainer.appendChild(listItem);
    }
  }

  // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–ã¨ãƒãƒ£ãƒƒãƒˆä¸€è¦§å–å¾—
  onAuthStateChanged(auth, (user) => {
    if (user) {
      const currentUserId = user.uid;
      const interactionsRef = collection(db, "interactions");
      const q = query(interactionsRef, where("participants", "array-contains", currentUserId));

      onSnapshot(q, (snapshot) => {
        renderChatList(snapshot.docs, currentUserId);
      });
    }
  });


  // æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç†
  document.querySelector('.btn-back').addEventListener('click', () => {
    window.history.back();
  });
</script>

</body>
</html>
